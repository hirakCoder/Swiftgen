<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftGen AI - iOS App Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        /* Animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .message-enter {
            animation: slideUp 0.4s ease-out;
        }

        .status-message {
            animation: fadeIn 0.3s ease-out;
        }

        .typing-indicator::after {
            content: "...";
            animation: typing 1.5s steps(3, end) infinite;
        }

        @keyframes typing {
            0% { content: "."; }
            33% { content: ".."; }
            66% { content: "..."; }
        }

        .progress-bar {
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #3b82f6 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Status card styles */
        .status-card {
            animation: slideUp 0.3s ease-out;
        }

        .error-pulse {
            animation: errorPulse 2s ease-in-out infinite;
        }

        @keyframes errorPulse {
            0% { background-color: rgba(239, 68, 68, 0.1); }
            50% { background-color: rgba(239, 68, 68, 0.2); }
            100% { background-color: rgba(239, 68, 68, 0.1); }
        }

        .success-glow {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        .error-glow {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

<!-- Header -->
<header class="fixed top-0 left-0 right-0 bg-gray-900/80 backdrop-blur-md border-b border-gray-800 z-50">
    <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    SwiftGen AI
                </h1>
                <span class="text-xs text-gray-500 ml-2">iOS App Builder</span>
            </div>
            <div class="flex items-center space-x-4">
                <button id="newChatBtn" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg flex items-center space-x-2 transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span>New Project</span>
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="pt-20 pb-32 min-h-screen">
    <div class="container mx-auto px-4 max-w-6xl">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-12rem)]">

            <!-- Chat Section -->
            <div class="lg:col-span-2 flex flex-col bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden">

                <!-- Chat Header -->
                <div class="px-6 py-4 border-b border-gray-700">
                    <h2 class="text-lg font-semibold">Project Chat</h2>
                    <p class="text-sm text-gray-400" id="projectName">Start by describing your app idea</p>
                </div>

                <!-- Chat Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto px-6 py-4 space-y-4">
                    <!-- Welcome Message -->
                    <div class="message-enter">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-300 mb-1">SwiftGen AI</p>
                                <div class="bg-gray-900 rounded-lg p-4">
                                    <p class="text-gray-200">üëã Welcome to SwiftGen AI! I'm here to help you build iOS apps using natural language.</p>
                                    <p class="text-gray-200 mt-2">Just describe what kind of app you want to create, and I'll handle the rest!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Real-time Status Card (Initially Hidden) -->
                <div id="statusCard" class="hidden mx-6 mb-4">
                    <div class="status-card bg-gray-900/50 border border-gray-700 rounded-xl p-4">
                        <!-- Main Status Header -->
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div id="statusIcon" class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-400 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 id="statusTitle" class="font-medium text-white">Processing...</h3>
                                    <p id="statusMessage" class="text-sm text-gray-400">Initializing...</p>
                                </div>
                            </div>
                            <button id="toggleDetails" class="text-xs text-blue-400 hover:text-blue-300">
                                Show Details
                            </button>
                        </div>

                        <!-- Progress Bar -->
                        <div class="mb-3">
                            <div class="flex items-center justify-between text-sm mb-1">
                                <span id="progressStage" class="text-gray-400">Starting...</span>
                                <span id="progressPercent" class="text-blue-400 font-medium">0%</span>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-2 overflow-hidden">
                                <div id="progressBar" class="progress-bar h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Build Stages -->
                        <div class="grid grid-cols-5 gap-2 mb-3">
                            <div class="text-center">
                                <div id="stage-analyze" class="w-8 h-8 mx-auto mb-1 bg-gray-800 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <p class="text-xs text-gray-500">Analyze</p>
                            </div>
                            <div class="text-center">
                                <div id="stage-generate" class="w-8 h-8 mx-auto mb-1 bg-gray-800 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                    </svg>
                                </div>
                                <p class="text-xs text-gray-500">Generate</p>
                            </div>
                            <div class="text-center">
                                <div id="stage-build" class="w-8 h-8 mx-auto mb-1 bg-gray-800 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                    </svg>
                                </div>
                                <p class="text-xs text-gray-500">Build</p>
                            </div>
                            <div class="text-center">
                                <div id="stage-fix" class="w-8 h-8 mx-auto mb-1 bg-gray-800 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </div>
                                <p class="text-xs text-gray-500">Fix</p>
                            </div>
                            <div class="text-center">
                                <div id="stage-launch" class="w-8 h-8 mx-auto mb-1 bg-gray-800 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                </div>
                                <p class="text-xs text-gray-500">Launch</p>
                            </div>
                        </div>

                        <!-- Detailed Messages (Initially Hidden) -->
                        <div id="detailsPanel" class="hidden border-t border-gray-700 pt-3 mt-3">
                            <div id="statusDetails" class="space-y-2 max-h-40 overflow-y-auto text-xs">
                                <!-- Status messages will appear here -->
                            </div>
                        </div>

                        <!-- Error Section (Initially Hidden) -->
                        <div id="errorSection" class="hidden mt-3 p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                            <div class="flex items-start space-x-2">
                                <svg class="w-5 h-5 text-red-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="flex-1">
                                    <p class="font-medium text-red-400 mb-1">Build Failed</p>
                                    <div id="errorList" class="space-y-1 text-sm text-red-300">
                                        <!-- Errors will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="px-6 py-4 border-t border-gray-700 bg-gray-900/50">
                    <form id="chatForm" class="flex items-end space-x-3">
                        <div class="flex-1">
                            <textarea
                                    id="chatInput"
                                    rows="1"
                                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 resize-none text-gray-100"
                                    placeholder="Describe your app or request changes..."
                                    style="min-height: 48px; max-height: 120px;"
                            ></textarea>
                        </div>
                        <button
                                type="submit"
                                id="sendBtn"
                                class="px-5 py-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white rounded-xl font-medium transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Code Preview Section -->
            <div class="flex flex-col bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden">

                <!-- Code Preview Header -->
                <div class="px-6 py-4 border-b border-gray-700">
                    <h2 class="text-lg font-semibold">Code Preview</h2>
                    <p class="text-sm text-gray-400">Generated Swift files</p>
                </div>

                <!-- File Tabs -->
                <div id="fileTabs" class="hidden border-b border-gray-700 overflow-x-auto">
                    <div class="flex items-center px-4" id="fileTabsContainer">
                        <!-- Tabs will be inserted here -->
                    </div>
                </div>

                <!-- Code Display -->
                <div class="flex-1 overflow-hidden">
                    <div id="codeDisplay" class="hidden h-full">
                        <pre class="h-full overflow-auto p-6 bg-gray-900"><code id="codeContent" class="text-sm text-gray-300"></code></pre>
                    </div>
                    <div id="noCodeMessage" class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                            </svg>
                            <p>Generated code will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- Simulator Status -->
                <div id="simulatorStatus" class="hidden px-6 py-4 border-t border-gray-700 bg-gray-900/50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></div>
                            <span class="text-sm text-gray-300">Simulator Running</span>
                        </div>
                        <button onclick="swiftgenChat.showBuildLogs()" class="text-xs text-blue-400 hover:text-blue-300">View Logs</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Bottom Status Bar -->
<div class="fixed bottom-0 left-0 right-0 bg-gray-800/80 backdrop-blur-md border-t border-gray-700">
    <div class="container mx-auto px-4 py-2">
        <div class="flex items-center justify-between text-sm">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div id="statusIndicator" class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span id="statusText" class="text-gray-400">Ready</span>
                </div>
            </div>
            <div class="flex items-center space-x-4 text-gray-500">
                <span id="projectInfo"></span>
            </div>
        </div>
    </div>
</div>

<script>
    // Enhanced SwiftGen Chat with Better Real-time Status and Logging
    class SwiftGenChat {
        constructor() {
            this.ws = null;
            this.currentProjectId = null;
            this.generatedFiles = [];
            this.messageHistory = [];
            this.isProcessing = false;
            this.currentContext = {
                appName: '',
                description: '',
                features: []
            };
            this.projects = [];
            this.buildLogs = [];
            this.editingFile = null;
            this.statusMessages = [];
            this.detailsExpanded = false;
            this.currentStage = null;

            // Enable logging
            this.debug = true;
            this.log('SwiftGenChat initialized');

            this.initializeEventListeners();
            this.setupTextareaAutoResize();
            this.loadProjects();
        }

        log(message, data = null) {
            if (this.debug) {
                const timestamp = new Date().toISOString();
                if (data) {
                    console.log(`[SwiftGen ${timestamp}] ${message}`, data);
                } else {
                    console.log(`[SwiftGen ${timestamp}] ${message}`);
                }
            }
        }

        logError(message, error = null) {
            const timestamp = new Date().toISOString();
            if (error) {
                console.error(`[SwiftGen ERROR ${timestamp}] ${message}`, error);
            } else {
                console.error(`[SwiftGen ERROR ${timestamp}] ${message}`);
            }
        }

        initializeEventListeners() {
            this.log('Initializing event listeners');

            document.getElementById('chatForm').addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleChatSubmit();
            });

            document.getElementById('newChatBtn').addEventListener('click', () => {
                this.startNewProject();
            });

            document.getElementById('chatInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.handleChatSubmit();
                }
            });

            document.getElementById('toggleDetails').addEventListener('click', () => {
                this.toggleDetails();
            });
        }

        toggleDetails() {
            const detailsPanel = document.getElementById('detailsPanel');
            const toggleBtn = document.getElementById('toggleDetails');

            this.detailsExpanded = !this.detailsExpanded;

            if (this.detailsExpanded) {
                detailsPanel.classList.remove('hidden');
                toggleBtn.textContent = 'Hide Details';
            } else {
                detailsPanel.classList.add('hidden');
                toggleBtn.textContent = 'Show Details';
            }
        }

        showStatusCard(title = 'Processing...') {
            try {
                this.log('Showing status card', { title });
                const statusCard = document.getElementById('statusCard');
                statusCard.classList.remove('hidden');

                document.getElementById('statusTitle').textContent = title;
                document.getElementById('statusMessage').textContent = 'Initializing...';
                document.getElementById('progressPercent').textContent = '0%';
                document.getElementById('progressBar').style.width = '0%';

                // Reset stages - Fixed SVG class handling
                ['analyze', 'generate', 'build', 'fix', 'launch'].forEach(stage => {
                    const stageEl = document.getElementById(`stage-${stage}`);
                    if (stageEl) {
                        stageEl.className = 'w-8 h-8 mx-auto mb-1 bg-gray-800 rounded-full flex items-center justify-center';
                        const svg = stageEl.querySelector('svg');
                        if (svg) {
                            // Use setAttribute for SVG elements
                            svg.setAttribute('class', 'w-4 h-4 text-gray-600');
                        }
                    }
                });

                // Hide error section
                document.getElementById('errorSection').classList.add('hidden');

                // Clear details
                document.getElementById('statusDetails').innerHTML = '';

                this.log('Status card shown successfully');
            } catch (error) {
                this.logError('Error showing status card', error);
            }
        }

        hideStatusCard() {
            setTimeout(() => {
                const statusCard = document.getElementById('statusCard');
                if (!document.getElementById('errorSection').classList.contains('hidden')) {
                    // Keep showing if there are errors
                    return;
                }
                statusCard.classList.add('hidden');
                this.log('Status card hidden');
            }, 2000);
        }

        updateStatusStage(stage, status = 'active') {
            try {
                this.log('Updating status stage', { stage, status });

                const stageEl = document.getElementById(`stage-${stage}`);
                if (!stageEl) {
                    this.logError(`Stage element not found: stage-${stage}`);
                    return;
                }

                const colors = {
                    active: 'bg-blue-500/20',
                    complete: 'bg-green-500/20',
                    error: 'bg-red-500/20',
                    inactive: 'bg-gray-800'
                };

                const iconColors = {
                    active: 'text-blue-400 spinner',
                    complete: 'text-green-400',
                    error: 'text-red-400',
                    inactive: 'text-gray-600'
                };

                stageEl.className = `w-8 h-8 mx-auto mb-1 ${colors[status]} rounded-full flex items-center justify-center transition-all`;

                const svg = stageEl.querySelector('svg');
                if (svg) {
                    // Use setAttribute for SVG elements
                    svg.setAttribute('class', `w-4 h-4 ${iconColors[status]}`);

                    if (status === 'complete') {
                        // Replace with checkmark
                        svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
                    } else if (status === 'error') {
                        // Replace with X
                        svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
                    }
                }

                this.currentStage = stage;
                this.log('Stage updated successfully');
            } catch (error) {
                this.logError('Error updating status stage', error);
            }
        }

        addStatusDetail(message) {
            try {
                const statusDetails = document.getElementById('statusDetails');
                const timestamp = new Date().toLocaleTimeString();

                const messageEl = document.createElement('div');
                messageEl.className = 'status-message flex items-start space-x-2 text-gray-400';
                messageEl.innerHTML = `
                <span class="text-gray-500">[${timestamp}]</span>
                <span>${this.escapeHtml(message)}</span>
            `;

                statusDetails.appendChild(messageEl);
                statusDetails.scrollTop = statusDetails.scrollHeight;

                // Keep only last 30 messages
                while (statusDetails.children.length > 30) {
                    statusDetails.removeChild(statusDetails.firstChild);
                }

                this.log('Status detail added', { message });
            } catch (error) {
                this.logError('Error adding status detail', error);
            }
        }

        updateProgress(percent, message) {
            try {
                document.getElementById('progressPercent').textContent = `${percent}%`;
                document.getElementById('progressBar').style.width = `${percent}%`;
                document.getElementById('progressStage').textContent = message;
                this.log('Progress updated', { percent, message });
            } catch (error) {
                this.logError('Error updating progress', error);
            }
        }

        showErrors(errors) {
            try {
                this.log('Showing errors', { errorCount: errors.length });

                const errorSection = document.getElementById('errorSection');
                const errorList = document.getElementById('errorList');

                errorSection.classList.remove('hidden');
                errorList.innerHTML = errors.map(error =>
                    `<div>‚Ä¢ ${this.escapeHtml(error)}</div>`
                ).join('');

                // Update status icon to error
                const statusIcon = document.getElementById('statusIcon');
                statusIcon.className = 'w-8 h-8 bg-red-500/20 rounded-lg flex items-center justify-center';
                statusIcon.innerHTML = `
                <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            `;

                document.getElementById('statusTitle').textContent = 'Build Failed';
                document.getElementById('statusMessage').textContent = 'Attempting to fix errors...';
            } catch (error) {
                this.logError('Error showing errors', error);
            }
        }

        setupTextareaAutoResize() {
            const textarea = document.getElementById('chatInput');
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            });
        }

        async loadProjects() {
            try {
                this.log('Loading projects...');
                const response = await fetch('/api/projects');
                if (response.ok) {
                    this.projects = await response.json();
                    this.updateProjectsList();
                    this.log('Projects loaded', { count: this.projects.length });
                }
            } catch (error) {
                this.logError('Failed to load projects', error);
            }
        }

        updateProjectsList() {
            const projectInfo = document.getElementById('projectInfo');
            if (this.projects.length > 0) {
                projectInfo.innerHTML = `
                <select id="projectSelect" class="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm">
                    <option value="">Select a project</option>
                    ${this.projects.map(p => `
                        <option value="${p.project_id}">${p.app_name} - ${new Date(p.created_at).toLocaleDateString()}</option>
                    `).join('')}
                </select>
            `;

                document.getElementById('projectSelect').addEventListener('change', (e) => {
                    if (e.target.value) {
                        this.loadProject(e.target.value);
                    }
                });
            }
        }

        async handleChatSubmit() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || this.isProcessing) return;

            this.log('Handling chat submit', { message, hasCurrentProject: !!this.currentProjectId });

            this.addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';

            const intent = this.analyzeIntent(message);
            this.log('Intent analyzed', intent);

            if (intent.type === 'create_app') {
                await this.createNewApp(intent.appName, message);
            } else if (intent.type === 'modify_app' && this.currentProjectId) {
                await this.modifyExistingApp(message);
            } else if (this.currentProjectId) {
                // If we have a project but intent wasn't detected as modify, still try to modify
                this.log('Defaulting to modification for existing project');
                await this.modifyExistingApp(message);
            } else {
                this.handleQuestion(message);
            }
        }

        analyzeIntent(message) {
            const lowerMessage = message.toLowerCase();

            // Check for app creation keywords
            const createKeywords = ['create', 'build', 'make', 'develop', 'new'];
            const hasCreateKeyword = createKeywords.some(keyword => lowerMessage.includes(keyword));

            // Check for modification keywords - EXPANDED LIST
            const modifyKeywords = [
                'add', 'change', 'modify', 'update', 'remove', 'delete', 'fix', 'edit',
                'improve', 'enhance', 'adjust', 'correct', 'repair', 'alter', 'revise',
                'implement', 'include', 'integrate', 'support', 'enable', 'disable',
                'increase', 'decrease', 'resize', 'move', 'style', 'color', 'dark mode',
                'bug', 'issue', 'problem', 'error', 'wrong', 'broken', 'not working',
                'make it', 'can you', 'please', 'need', 'want', 'should'
            ];
            const hasModifyKeyword = modifyKeywords.some(keyword => lowerMessage.includes(keyword));

            // Extract app name if mentioned
            let appName = 'MyApp';
            const appNameMatch = message.match(/(?:called?|named?)\s+["']?([^"']+)["']?/i);
            if (appNameMatch) {
                appName = appNameMatch[1].trim();
            }

            // CRITICAL FIX: If we have a current project, default to modification
            if (this.currentProjectId) {
                // Only create new app if explicitly asked
                if (hasCreateKeyword && (lowerMessage.includes('new app') || lowerMessage.includes('another app') || lowerMessage.includes('different app'))) {
                    return { type: 'create_app', appName };
                }
                // Default to modification for existing projects
                return { type: 'modify_app' };
            } else {
                // No current project - create new app
                if (hasCreateKeyword || !hasModifyKeyword) {
                    return { type: 'create_app', appName };
                } else {
                    return { type: 'question' };
                }
            }
        }

        async createNewApp(appName, description) {
            this.log('Creating new app', { appName, description });

            this.isProcessing = true;
            this.buildLogs = [];
            this.statusMessages = [];

            this.currentContext = {
                appName,
                description,
                features: []
            };

            document.getElementById('projectName').textContent = `Building: ${appName}`;

            this.showStatusCard(`Creating ${appName}`);
            this.updateStatusStage('analyze', 'active');

            this.addMessage('assistant', `Great! I'll create ${appName} for you. Let me analyze your requirements and build the app...`, true);

            try {
                const tempProjectId = `proj_${Date.now()}`;
                this.connectWebSocket(tempProjectId);

                this.log('Sending generate request to API');
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        app_name: appName,
                        description: description
                    })
                });

                this.log('API response received', { status: response.status });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                this.log('API result', result);

                // CRITICAL: Store the project ID
                this.currentProjectId = result.project_id;

                // Store the bundle ID in context
                if (result.bundle_id) {
                    this.currentContext.bundle_id = result.bundle_id;
                }

                if (result.generated_files && result.generated_files.length > 0) {
                    this.generatedFiles = result.generated_files;
                    this.displayGeneratedCode(result.generated_files);
                }

                if (result.status === 'success') {
                    this.updateProgress(100, 'Complete!');
                    this.updateStatusStage('launch', 'complete');

                    // Update status icon to success
                    const statusIcon = document.getElementById('statusIcon');
                    statusIcon.className = 'w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center success-glow';
                    statusIcon.innerHTML = `
                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            `;

                    document.getElementById('statusTitle').textContent = 'Build Successful!';
                    document.getElementById('statusMessage').textContent = `${result.app_name} is ready`;

                    let successMessage = `‚úÖ ${result.app_name} has been successfully created!`;

                    if (result.features && result.features.length > 0) {
                        successMessage += `\n\nFeatures implemented:\n${result.features.map(f => `‚Ä¢ ${f}`).join('\n')}`;
                    }

                    if (result.simulator_launched) {
                        successMessage += '\n\nüì± The app is now running in the iOS Simulator!';
                        this.showSimulatorStatus(true);
                    }

                    this.addMessage('assistant', successMessage);
                    this.updateStatus('ready', 'App running in simulator');
                    this.loadProjects();

                    this.hideStatusCard();
                } else if (result.status === 'warning') {
                    // Build succeeded but launch failed
                    this.updateProgress(100, 'Build complete, launch failed');
                    this.updateStatusStage('launch', 'error');

                    const statusIcon = document.getElementById('statusIcon');
                    statusIcon.className = 'w-8 h-8 bg-yellow-500/20 rounded-lg flex items-center justify-center';
                    statusIcon.innerHTML = `
                <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            `;

                    document.getElementById('statusTitle').textContent = 'Build Successful';
                    document.getElementById('statusMessage').textContent = 'App built but launch failed';

                    let warningMessage = `‚úÖ ${result.app_name} has been successfully built!\n\n`;
                    warningMessage += `‚ö†Ô∏è The app couldn't launch in the simulator automatically. This might be due to:\n`;
                    warningMessage += `‚Ä¢ Simulator needs to be opened manually\n`;
                    warningMessage += `‚Ä¢ The app name contains special characters\n\n`;
                    warningMessage += `You can open the app manually from Xcode or the simulator.`;

                    this.addMessage('assistant', warningMessage);
                    this.loadProjects();
                } else {
                    this.showErrors(result.build_result.errors || ['Unknown build error']);
                    this.updateStatusStage('build', 'error');
                    this.buildLogs = result.build_result.errors || [];
                }

            } catch (error) {
                this.logError('Error creating app', error);
                this.addMessage('assistant', `‚ùå Failed to create app: ${error.message}`);
                this.updateStatusStage(this.currentStage || 'analyze', 'error');
            } finally {
                this.isProcessing = false;
            }
        }

        async modifyExistingApp(request) {
            this.log('Modifying existing app', { request });

            this.isProcessing = true;
            this.buildLogs = [];
            this.statusMessages = [];

            this.showStatusCard('Modifying App');
            this.updateStatusStage('analyze', 'active');

            this.addMessage('assistant', "I'll modify your app based on your request. Let me update the code and rebuild...", true);

            try {
                const response = await fetch('/api/modify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        project_id: this.currentProjectId,
                        modification: request,
                        context: this.currentContext
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.modified_files && result.modified_files.length > 0) {
                    this.generatedFiles = result.modified_files;
                    this.displayGeneratedCode(result.modified_files);
                }

                if (result.status === 'success') {
                    this.updateProgress(100, 'Modification complete!');
                    this.updateStatusStage('launch', 'complete');

                    let message = `‚úÖ I've successfully modified your app!\n\n`;
                    if (result.features_added && result.features_added.length > 0) {
                        message += `New features added:\n${result.features_added.map(f => `‚Ä¢ ${f}`).join('\n')}`;
                    }
                    message += '\n\nThe app has been rebuilt and relaunched in the simulator.';

                    this.addMessage('assistant', message);
                    this.updateStatus('ready', 'App modified and running');

                    this.hideStatusCard();
                } else {
                    this.showErrors(result.build_result.errors || ['Modification failed']);
                    this.updateStatusStage('build', 'error');
                    this.buildLogs = result.build_result.errors || [];
                }

            } catch (error) {
                this.logError('Error modifying app', error);
                this.addMessage('assistant', `‚ùå Failed to modify app: ${error.message}`);
                this.updateStatusStage(this.currentStage || 'analyze', 'error');
            } finally {
                this.isProcessing = false;
            }
        }

        connectWebSocket(projectId) {
            if (this.ws) {
                this.ws.close();
            }

            const wsUrl = `ws://localhost:8000/ws/${projectId}`;
            this.log('Connecting WebSocket', { wsUrl });

            this.ws = new WebSocket(wsUrl);

            this.ws.onopen = () => {
                this.log('WebSocket connected');
                this.updateStatus('connected', 'Connected to server');
            };

            this.ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                this.log('WebSocket message received', message);
                this.handleWebSocketMessage(message);
            };

            this.ws.onerror = (error) => {
                this.logError('WebSocket error', error);
                this.updateStatus('error', 'Connection error');
            };

            this.ws.onclose = () => {
                this.log('WebSocket disconnected');
                this.updateStatus('disconnected', 'Disconnected from server');
            };
        }

        handleWebSocketMessage(message) {
            this.log('Handling WebSocket message', { type: message.type });

            switch (message.type) {
                case 'status':
                    this.handleStatusUpdate(message.message, message.status);
                    break;
                case 'complete':
                    this.log('Build complete message received');
                    break;
                case 'error':
                    if (message.errors) {
                        this.buildLogs = message.errors;
                        this.showErrors(message.errors);
                    }
                    break;
            }
        }

        handleStatusUpdate(statusMessage, status) {
            this.log('Status update', { statusMessage, status });

            // Add to details
            this.addStatusDetail(statusMessage);

            // Update main message
            document.getElementById('statusMessage').textContent = statusMessage;

            // Update progress and stages based on message content
            if (statusMessage.includes('Analyzing your request')) {
                this.updateProgress(10, 'Analyzing request...');
                this.updateStatusStage('analyze', 'active');
            } else if (statusMessage.includes('Creating') && statusMessage.includes('unique features')) {
                this.updateProgress(20, 'Creating unique features...');
                this.updateStatusStage('analyze', 'complete');
                this.updateStatusStage('generate', 'active');
            } else if (statusMessage.includes('Generating Swift code')) {
                this.updateProgress(30, 'Generating Swift code...');
            } else if (statusMessage.includes('Building your unique app')) {
                this.updateProgress(40, 'Starting build process...');
                this.updateStatusStage('generate', 'complete');
                this.updateStatusStage('build', 'active');
            } else if (statusMessage.includes('Generating Xcode project')) {
                this.updateProgress(45, 'Generating Xcode project...');
            } else if (statusMessage.includes('Cleaning build folder')) {
                this.updateProgress(50, 'Preparing build environment...');
            } else if (statusMessage.includes('Building app')) {
                this.updateProgress(60, 'Compiling Swift code...');
            } else if (statusMessage.includes('Build failed')) {
                this.updateProgress(65, 'Build failed - analyzing errors...');
                this.updateStatusStage('build', 'error');
                this.updateStatusStage('fix', 'active');
            } else if (statusMessage.includes('Analyzing errors')) {
                this.updateProgress(70, 'Analyzing build errors...');
            } else if (statusMessage.includes('AI fix') || statusMessage.includes('Applying')) {
                this.updateProgress(75, 'Applying intelligent fixes...');
            } else if (statusMessage.includes('Build successful')) {
                this.updateProgress(80, 'Build completed successfully!');
                this.updateStatusStage('build', 'complete');
                this.updateStatusStage('fix', 'complete');
                this.updateStatusStage('launch', 'active');
            } else if (statusMessage.includes('Booting simulator')) {
                this.updateProgress(85, 'Starting iOS Simulator...');
            } else if (statusMessage.includes('Installing')) {
                this.updateProgress(90, 'Installing app to simulator...');
            } else if (statusMessage.includes('Launching')) {
                this.updateProgress(95, 'Launching your app...');
            } else if (statusMessage.includes('‚úÖ')) {
                this.updateProgress(100, 'Complete!');
                this.updateStatusStage('launch', 'complete');
            }
        }

        // Replace the displayGeneratedCode method in your index.html (around line 1048)
        displayGeneratedCode(files) {
            const codeDisplay = document.getElementById('codeDisplay');
            const noCodeMessage = document.getElementById('noCodeMessage');
            const fileTabs = document.getElementById('fileTabs');
            const fileTabsContainer = document.getElementById('fileTabsContainer');

            // CRITICAL: Validate files have content
            const validFiles = files.filter(file => {
                if (!file.content || !file.content.trim()) {
                    console.error(`File ${file.path} has no content!`);
                    return false;
                }
                return true;
            });

            if (validFiles.length === 0) {
                console.error('No valid files with content found');
                this.addMessage('assistant', '‚ö†Ô∏è Warning: No valid code files were generated. This might be a generation error. Please try again.');

                // Hide code display
                codeDisplay.classList.add('hidden');
                noCodeMessage.classList.remove('hidden');
                fileTabs.classList.add('hidden');
                return;
            }

            // Use only valid files
            files = validFiles;

            // Show code display, hide no-code message
            codeDisplay.classList.remove('hidden');
            noCodeMessage.classList.add('hidden');
            fileTabs.classList.remove('hidden');

            // Clear existing tabs
            fileTabsContainer.innerHTML = '';

            // Add action buttons with new Advanced Editor button
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'ml-auto flex items-center space-x-2';
            actionsDiv.innerHTML = `
        <button onclick="swiftgenChat.openCodeEditor()" class="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded flex items-center space-x-1">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
            </svg>
            <span>Advanced Editor</span>
        </button>
        <button onclick="swiftgenChat.startEditMode()" class="px-3 py-1 text-xs bg-dark-surface hover:bg-dark-hover border border-dark-border rounded">
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Quick Edit
        </button>
        <button onclick="swiftgenChat.exportProject()" class="px-3 py-1 text-xs bg-dark-surface hover:bg-dark-hover border border-dark-border rounded">
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Export
        </button>
    `;

            // Create tab container
            const tabContainer = document.createElement('div');
            tabContainer.className = 'flex items-center space-x-2 flex-1';

            // Create tabs for each file
            files.forEach((file, index) => {
                const fileName = file.path.split('/').pop();
                const tab = document.createElement('button');
                tab.className = `px-4 py-2 text-sm font-medium transition-all ${
                    index === 0
                        ? 'text-blue-400 border-b-2 border-blue-400'
                        : 'text-gray-400 hover:text-gray-200'
                }`;
                tab.textContent = fileName;
                tab.onclick = () => this.selectFile(index);
                tab.setAttribute('data-file-index', index);
                tabContainer.appendChild(tab);
            });

            fileTabsContainer.appendChild(tabContainer);
            fileTabsContainer.appendChild(actionsDiv);

            // Display first file
            if (files.length > 0) {
                this.selectFile(0);
            }
        }

// Also update the selectFile method (around line 1106)
        selectFile(index) {
            const tabs = document.querySelectorAll('#fileTabsContainer button[data-file-index]');
            const codeContent = document.getElementById('codeContent');

            tabs.forEach((tab, i) => {
                if (i === index) {
                    tab.className = 'px-4 py-2 text-sm font-medium transition-all text-blue-400 border-b-2 border-blue-400';
                } else {
                    tab.className = 'px-4 py-2 text-sm font-medium transition-all text-gray-400 hover:text-gray-200';
                }
            });

            const file = this.generatedFiles[index];

            // Validate file content before displaying
            if (!file || !file.content) {
                console.error(`File at index ${index} has no content`);
                codeContent.textContent = '// Error: No content available for this file';
                return;
            }

            codeContent.textContent = file.content;
            this.currentFileIndex = index;

            if (this.editingFile !== null) {
                codeContent.contentEditable = true;
                codeContent.className = 'text-sm text-gray-300 outline-none';
            }
        }

        async saveFileChanges() {
            const codeContent = document.getElementById('codeContent');
            const editButton = document.querySelector('button[onclick="swiftgenChat.startEditMode()"]');

            const newContent = codeContent.textContent;
            const file = this.generatedFiles[this.editingFile];

            file.content = newContent;

            codeContent.contentEditable = false;
            codeContent.className = 'text-sm text-gray-300';
            this.editingFile = null;

            editButton.innerHTML = `
            <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Quick Edit
        `;
            editButton.className = 'px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 border border-gray-600 rounded';

            try {
                const response = await fetch('/api/modify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        project_id: this.currentProjectId,
                        modification: 'Manual code edit',
                        context: {
                            ...this.currentContext,
                            manual_edit: true,
                            edited_files: [file]
                        }
                    })
                });

                if (response.ok) {
                    this.addMessage('assistant', '‚úÖ Changes saved and app rebuilt successfully!');
                } else {
                    this.addMessage('assistant', '‚ùå Failed to save changes. Please try again.');
                }
            } catch (error) {
                this.logError('Save error', error);
                this.addMessage('assistant', '‚ùå Error saving changes: ' + error.message);
            }
        }

        async exportProject() {
            if (!this.currentProjectId || this.generatedFiles.length === 0) {
                this.addMessage('assistant', 'No project to export. Please create an app first.');
                return;
            }

            const zip = new JSZip();

            this.generatedFiles.forEach(file => {
                zip.file(file.path, file.content);
            });

            const projectInfo = {
                app_name: this.currentContext.appName,
                description: this.currentContext.description,
                created_at: new Date().toISOString(),
                exported_at: new Date().toISOString()
            };
            zip.file('project_info.json', JSON.stringify(projectInfo, null, 2));

            try {
                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.currentContext.appName || 'SwiftGenApp'}.zip`;
                a.click();
                URL.revokeObjectURL(url);

                this.addMessage('assistant', `‚úÖ Project exported successfully as ${a.download}`);
            } catch (error) {
                this.logError('Export error', error);
                this.addMessage('assistant', '‚ùå Failed to export project. Please try again.');
            }
        }

        showBuildLogs() {
            if (this.buildLogs.length === 0) {
                this.addMessage('assistant', 'No build logs available yet. Create or modify an app to see logs.');
                return;
            }

            const logsHtml = this.buildLogs.map(log => `<div class="text-xs text-gray-400 font-mono">${this.escapeHtml(log)}</div>`).join('');

            this.addMessage('assistant', `<div class="mt-2 p-3 bg-gray-800 rounded-lg border border-gray-700">
            <p class="text-sm font-medium text-gray-300 mb-2">Build Logs:</p>
            <div class="space-y-1 max-h-60 overflow-y-auto">
                ${logsHtml}
            </div>
        </div>`);
        }

        showSimulatorStatus(isRunning) {
            const statusDiv = document.getElementById('simulatorStatus');
            if (isRunning) {
                statusDiv.classList.remove('hidden');
            } else {
                statusDiv.classList.add('hidden');
            }
        }

        updateStatus(type, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            const statusConfig = {
                'ready': { color: 'bg-green-500', text: 'Ready' },
                'connected': { color: 'bg-green-500', text: message },
                'processing': { color: 'bg-yellow-500', text: message },
                'error': { color: 'bg-red-500', text: message },
                'disconnected': { color: 'bg-gray-500', text: message }
            };

            const config = statusConfig[type] || statusConfig.ready;
            indicator.className = `w-2 h-2 rounded-full ${config.color}`;
            text.textContent = config.text;
        }

        startNewProject() {
            if (this.isProcessing) {
                alert('Please wait for the current process to complete.');
                return;
            }

            this.currentProjectId = null;
            this.generatedFiles = [];
            this.currentContext = { appName: '', description: '', features: [] };
            this.buildLogs = [];
            this.editingFile = null;

            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('codeContent').textContent = '';
            document.getElementById('fileTabsContainer').innerHTML = '';
            document.getElementById('codeDisplay').classList.add('hidden');
            document.getElementById('noCodeMessage').classList.remove('hidden');
            document.getElementById('fileTabs').classList.add('hidden');
            document.getElementById('simulatorStatus').classList.add('hidden');
            document.getElementById('statusCard').classList.add('hidden');
            document.getElementById('projectName').textContent = 'Start by describing your app idea';

            this.addMessage('assistant', "üëã Ready to create a new iOS app! What would you like to build?");
            document.getElementById('chatInput').focus();
        }

        handleQuestion(message) {
            const responses = {
                'help': "I can help you create iOS apps using natural language! Just describe what you want to build.",
                'features': "I can create various types of iOS apps including todo lists, calculators, weather apps, timers, and more!",
                'modify': "Once your app is created, you can ask me to modify it by describing the changes you want.",
                'export': "You can export your project by clicking the Export button in the code preview section."
            };

            const lowerMessage = message.toLowerCase();
            let response = responses.help;

            if (lowerMessage.includes('feature') || lowerMessage.includes('what can')) {
                response = responses.features;
            } else if (lowerMessage.includes('modify') || lowerMessage.includes('change')) {
                response = responses.modify;
            } else if (lowerMessage.includes('export') || lowerMessage.includes('download')) {
                response = responses.export;
            }

            this.addMessage('assistant', response);
        }

        async loadProject(projectId) {
            try {
                const response = await fetch(`/api/project/${projectId}/status`);
                if (response.ok) {
                    const project = await response.json();
                    this.currentProjectId = projectId;
                    this.currentContext = project.context || {};

                    const filesResponse = await fetch(`/api/project/${projectId}/files`);
                    if (filesResponse.ok) {
                        const filesData = await filesResponse.json();
                        this.generatedFiles = filesData.files;
                        this.displayGeneratedCode(this.generatedFiles);
                    }

                    document.getElementById('projectName').textContent = `Project: ${project.app_name}`;
                    this.addMessage('assistant', `Loaded project: ${project.app_name}. You can now modify it or view the code.`);

                    this.connectWebSocket(projectId);
                }
            } catch (error) {
                this.logError('Failed to load project', error);
                this.addMessage('assistant', 'Failed to load project. Please try again.');
            }
        }

        addMessage(sender, content, isTyping = false, errors = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-enter';

            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            if (sender === 'user') {
                messageDiv.innerHTML = `
                <div class="flex items-start space-x-3 justify-end">
                    <div class="flex-1 max-w-md">
                        <p class="text-sm font-medium text-gray-300 mb-1 text-right">You</p>
                        <div class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 border border-blue-500/30 rounded-lg p-4">
                            <p class="text-gray-200 whitespace-pre-wrap">${this.escapeHtml(content)}</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 text-right">${timestamp}</p>
                    </div>
                    <div class="w-8 h-8 bg-gray-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
            `;
            } else {
                let contentHtml = content.split('\n').map(line => `<p>${this.escapeHtml(line)}</p>`).join('');
                if (isTyping) {
                    contentHtml = `<span class="typing-indicator">${contentHtml}</span>`;
                }

                if (errors && errors.length > 0) {
                    contentHtml += `
                    <div class="mt-3 p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                        <p class="text-sm font-medium text-red-400 mb-2">Build Errors:</p>
                        <ul class="text-sm text-red-300 space-y-1">
                            ${errors.map(error => `<li>‚Ä¢ ${this.escapeHtml(error)}</li>`).join('')}
                        </ul>
                    </div>
                `;
                }

                messageDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 max-w-md">
                        <p class="text-sm font-medium text-gray-300 mb-1">SwiftGen AI</p>
                        <div class="bg-gray-900 rounded-lg p-4">
                            <div class="text-gray-200 space-y-1">${contentHtml}</div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${timestamp}</p>
                    </div>
                </div>
            `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            this.messageHistory.push({ sender, content, timestamp });
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }

    // Initialize the chat interface
    document.addEventListener('DOMContentLoaded', () => {
        window.swiftgenChat = new SwiftGenChat();
        console.log('SwiftGen Chat initialized');
    });
</script>

</body>
</html>